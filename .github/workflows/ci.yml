name: CI/CD Pipeline - WingTradeBot

# 1. TRIGGERS: When will this run?
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

# 2. JOBS: The tasks we will execute
jobs:
  build-and-test:
    name: Build & Test
    # GitHub spins up the latest Ubuntu machine in their cloud for us:
    runs-on: ubuntu-latest

    # 3. STEPS: The sequence of commands the GitHub runner will execute
    steps:
      # Step 1: GitHub doesn't have your code yet. This action "pulls" your code to their server.
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: The Ubuntu runner is bare. We need to install Node.js.
      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Stable Node version
          cache: 'npm'       # Caches packages to speed up future pipeline runs

      # Step 3: Now that we have Node and Code, install the packages.
      # We use npm ci (clean install) because it strictly follows package-lock.json, ideal for CI/CD.
      - name: Install Dependencies
        run: npm ci

      # Step 3.5: Since we ignore src/config.ts for security, TypeScript needs it (or the example) to compile
      - name: Setup Dummy Config
        run: cp src/config.example.ts src/config.ts

      # Step 4 (Linter Checks): Since we use TypeScript, ensure it compiles without errors
      - name: Validate TypeScript (Linter / Build Check)
        run: npx tsc --noEmit

      # Step 5: Run the tests we wrote! Unit and Integration tests
      - name: Run Unit Tests & Container/DB Tests
        run: npm test

      # Step 6: Create the Docker image proving that the Dockerfile works
      - name: Build Docker Image
        run: docker build -t wingtradebot:test .
        