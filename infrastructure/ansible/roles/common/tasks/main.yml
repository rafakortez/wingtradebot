---
# Role: common — base server configuration and hardening

# ─── Swap ──────────────────────────────────────────────────────────────────
- name: Check if swapfile exists
  stat:
    path: /swapfile
  register: swapfile

- name: Create swapfile ({{ swap_size_mb }}MB)
  command: fallocate -l {{ swap_size_mb }}M /swapfile
  when: not swapfile.stat.exists

- name: Set swapfile permissions
  file:
    path: /swapfile
    mode: "0600"
  when: not swapfile.stat.exists

- name: Format swapfile
  command: mkswap /swapfile
  when: not swapfile.stat.exists

- name: Activate swapfile
  command: swapon /swapfile
  when: not swapfile.stat.exists

- name: Persist swap in fstab
  lineinfile:
    path: /etc/fstab
    line: "/swapfile none swap sw 0 0"
    state: present

# ─── Journald ──────────────────────────────────────────────────────────────
- name: Create journald config directory
  file:
    path: /etc/systemd/journald.conf.d
    state: directory
    mode: "0755"

- name: Configure journald log limits
  copy:
    dest: /etc/systemd/journald.conf.d/limits.conf
    content: |
      [Journal]
      SystemMaxUse=50M
      RuntimeMaxUse=20M
      MaxRetentionSec=7day
      Compress=yes
  notify: Restart journald

# ─── SSH hardening ─────────────────────────────────────────────────────────
- name: Set custom SSH port ({{ ssh_port }})
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?Port "
    line: "Port {{ ssh_port }}"
  notify: Restart sshd

- name: Disable password authentication
  lineinfile:
    path: /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
    regexp: "^PasswordAuthentication"
    line: "PasswordAuthentication no"
    create: yes
  notify: Restart sshd

# ─── fail2ban ──────────────────────────────────────────────────────────────
- name: Install fail2ban
  apt:
    name: fail2ban
    state: present
    update_cache: yes

- name: Configure fail2ban for custom SSH port
  copy:
    dest: /etc/fail2ban/jail.d/sshd.conf
    content: |
      [sshd]
      enabled = true
      port    = {{ ssh_port }}
      maxretry = 5
      bantime  = 3600
  notify: Restart fail2ban

# ─── Disable unnecessary services ─────────────────────────────────────────
- name: Disable ModemManager
  systemd:
    name: ModemManager
    state: stopped
    enabled: false
  ignore_errors: true

- name: Disable udisks2
  systemd:
    name: udisks2
    state: stopped
    enabled: false
  ignore_errors: true

# ─── Handlers ──────────────────────────────────────────────────────────────
handlers:
  - name: Restart journald
    systemd:
      name: systemd-journald
      state: restarted

  - name: Restart sshd
    systemd:
      name: ssh
      state: restarted

  - name: Restart fail2ban
    systemd:
      name: fail2ban
      state: restarted
