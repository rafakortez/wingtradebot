---
# Role: wingtradebot — Deploy the trading bot application

# ─── Directory and Source Code ─────────────────────────────────────────────
- name: Ensure app directory exists
  file:
    path: "{{ app_dir }}"
    state: directory
    mode: "0755"

- name: Copy project files to server
  synchronize:
    src: "{{ playbook_dir }}/../../"
    dest: "{{ app_dir }}/"
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=node_modules"
      - "--exclude=dist"
      - "--exclude=.env"
      - "--exclude=infrastructure"

- name: Install npm dependencies
  npm:
    path: "{{ app_dir }}"
    state: present
    production: yes

- name: Build TypeScript source
  command: npm run build
  args:
    chdir: "{{ app_dir }}"
  environment:
    NODE_OPTIONS: "--max-old-space-size=512"

# ─── Environment Configuration ─────────────────────────────────────────────
- name: Create .env file from template
  template:
    src: env.j2
    dest: "{{ app_dir }}/.env"
    mode: "0600"  # Read/write only for root
  notify: Restart wingtradebot

# ─── SSL Setup ─────────────────────────────────────────────────────────────
- name: Create app ssl directory
  file:
    path: "{{ app_dir }}/ssl"
    state: directory
    mode: "0700"

- name: Copy SSL certificate to server (if exists locally)
  copy:
    src: "{{ playbook_dir }}/../../ssl/cert.pem"
    dest: "{{ app_dir }}/ssl/cert.pem"
    mode: "0600"
  ignore_errors: true
  notify: Restart wingtradebot

- name: Copy SSL private key to server (if exists locally)
  copy:
    src: "{{ playbook_dir }}/../../ssl/key.pem"
    dest: "{{ app_dir }}/ssl/key.pem"
    mode: "0600"
  ignore_errors: true
  notify: Restart wingtradebot

# ─── Systemd Service ───────────────────────────────────────────────────────
- name: Install systemd service file
  template:
    src: wingtradebot.service.j2
    dest: /etc/systemd/system/wingtradebot.service
    mode: "0644"
  notify:
    - Reload systemd
    - Restart wingtradebot

- name: Enable and start wingtradebot service
  systemd:
    name: wingtradebot
    enabled: true
    state: started
    daemon_reload: true

# ─── Handlers ──────────────────────────────────────────────────────────────
handlers:
  - name: Reload systemd
    systemd:
      daemon_reload: true

  - name: Restart wingtradebot
    systemd:
      name: wingtradebot
      state: restarted
