---
# Role: wingtradebot — Deploy the trading bot application

# ─── Directory and Source Code ─────────────────────────────────────────────
- name: Clone or update repository
  git:
    repo: "{{ git_repo }}"
    dest: "{{ app_dir }}"
    version: "{{ git_branch }}"
    force: yes

- name: Install npm dependencies
  npm:
    path: "{{ app_dir }}"
    state: present
    production: yes

- name: Build TypeScript source
  command: npm run build
  args:
    chdir: "{{ app_dir }}"
  environment:
    NODE_OPTIONS: "--max-old-space-size=512"

# ─── Environment Configuration ─────────────────────────────────────────────
- name: Create .env file from template
  template:
    src: env.j2
    dest: "{{ app_dir }}/.env"
    mode: "0600"  # Read/write only for root
  notify: Restart wingtradebot

# ─── SSL Setup ─────────────────────────────────────────────────────────────
- name: Check if certbot is installed
  command: certbot --version
  register: certbot_check
  ignore_errors: true
  changed_when: false

- name: Install certbot (via snap)
  community.general.snap:
    name: certbot
    classic: yes
    state: present
  when: certbot_check.failed

- name: Issue Let's Encrypt certificate via DuckDNS
  command: >
    certbot certonly --standalone
    --non-interactive --agree-tos
    --email admin@{{ duckdns_domain }}
    -d {{ duckdns_domain }}
  args:
    creates: /etc/letsencrypt/live/{{ duckdns_domain }}/fullchain.pem
  when: certbot_check.failed

- name: Create app ssl directory
  file:
    path: "{{ app_dir }}/ssl"
    state: directory
    mode: "0700"

- name: Symlink certificate to app directory
  file:
    src: "/etc/letsencrypt/live/{{ duckdns_domain }}/fullchain.pem"
    dest: "{{ app_dir }}/ssl/cert.pem"
    state: link
    force: yes

- name: Symlink private key to app directory
  file:
    src: "/etc/letsencrypt/live/{{ duckdns_domain }}/privkey.pem"
    dest: "{{ app_dir }}/ssl/key.pem"
    state: link
    force: yes

- name: Setup cron job for automatic certificate renewal
  cron:
    name: "Renew Let's Encrypt certificate"
    job: "certbot renew --quiet && systemctl restart wingtradebot"
    special_time: weekly

# ─── Systemd Service ───────────────────────────────────────────────────────
- name: Install systemd service file
  template:
    src: wingtradebot.service.j2
    dest: /etc/systemd/system/wingtradebot.service
    mode: "0644"
  notify:
    - Reload systemd
    - Restart wingtradebot

- name: Enable and start wingtradebot service
  systemd:
    name: wingtradebot
    enabled: true
    state: started
    daemon_reload: true

# ─── Handlers ──────────────────────────────────────────────────────────────
handlers:
  - name: Reload systemd
    systemd:
      daemon_reload: true

  - name: Restart wingtradebot
    systemd:
      name: wingtradebot
      state: restarted
